<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>BAGeL Radio Playlist</title>
  <style>
    body {
      font-family: "Droid sans", "Lucida Grande", sans-serif;
      color: #eee;
      background: black;
    }
    td {
      padding: 8px;
    }
    .title, .time, .day {
      font-size: smaller;
      color: #bbb;
    }
    .time, .day {
      text-align: right;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
  <script>
    let lastID = -1;
    let lastDay = '';
    const get = function() {
      $.getJSON('http://ingest2.cdnstream1.com:10000/ice_history.php?h=ingest2.cdnstream1.com&p=8000&i=2606_128.aac&https=0&f=ice&c=3999&rnd=' + Math.random(), function(json) {
        // Skip anything more than 5 min. into the future.
        let j, now = Date.now();
        for (j = 0; j < json.length; j++) {
          if (json[j].time < now + 5 * 60 * 1000) {
            break;
          }
        }
        if (j < json.length && json[j].time !== lastID) {
          let table = $('body table');
          for (let i = json.length; --i >= j;) {
            if (json[i].time > lastID) {
              lastID = json[i].time;
              const date = new Date(json[i].time);
              const day = new Intl.DateTimeFormat('en-US', {weekday: 'short'}).format(date);
              const song = '<div class="artist">' + json[i].artist + '</div><div class="title">' + json[i].title + '</div>';
              let t = '<div class="time">' + date.toLocaleTimeString('en-US').replace(/(^\d+:\d+):\d+/, '$1') + '</div>';
              if (day !== lastDay) {
                t += '<div class="day">' + day + '</div>';
                lastDay = day;
              }
              table.prepend('<tr><td>' + t + '</td><td></td><td class="song">' + song + '</td></tr>');
            }
          }
        }
      });
    };
    get();
    setInterval(get, 5000);
  </script>
</head>
<body>
<table></table>
</body>
</html>